
# Simple ingress with multiple rules

AWS Application load balancer is a reverse proxy that can route requests based on paths, headers and etc and we can take advantage of it with ingress on Kubernetes.

# How it works

Here [in this file](./2.ingress-multiple-rules.yaml) I added two ingresses resources that creates multiple rules in different ways.
The ingress named `basic-ingress-with-multiple-rules-1` creates rules based on host `AND` path. Like the first ingress, the `basic-ingress-with-multiple-rules-2` do the same thing but it uses the `condition` and `action` annotations which creates less rules because it uses the `OR` operator.


## Deeper into the manifests

### Rules

1. `basic-ingress-with-multiple-rules-1` will create the following rules in the ALB:

    1. if `HOST` is `basic-ingress-with-multiple-rules.testingdomain.com` **AND** `PATH` is `/this/is/the/second/rule/*` then it will redirect to the TargetGroup (the service).

    2. if `HOST` is `basic-ingress-with-multiple-rules.testingdomain.com` **AND** `PATH` is `/this/is/a/long/path/and/is/the/first/in/the/list/*` then it will redirect to the TargetGroup (the service).

    3. if `HOST` is `basic-ingress-with-multiple-rules.testingdomain.com` **AND** `PATH` is `/last/rule*` then it will redirect to the TargetGroup (the service).


2. `basic-ingress-with-multiple-rules-2` will create the following rules in the ALB:

    1. if `HOST` is `basic-ingress-with-multiple-rules.testingdomain.com` **AND** `PATH` is `/like-the-first-service/*` OR `/similar-to-the-first-service/*` then it will redirect to the TargetGroup (defined in the `alb.ingress.kubernetes.io/actions.forward-jeferson` annotation).

    2. if `HOST` is `basic-ingress-with-multiple-rules.testingdomain.com` **AND** `PATH` is `/second-service/*` then it will redirect to the TargetGroup (the service)


#### Order matters

According to the [alb-load-balancer-controller documentation](https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/ingress/spec/), `pathType` is key in defining the order the rules will be created on the ALB, which also means the priority. This is important and critical when the ALB has multiple rules and if the order is incorrect it can route the request to the wrong service or return an unexpected response.

The alb-load-balancer-controller will create the rules according to the order that we set them in the ingrees definition so we must be careful when defining the rules. 

Actually, it's important to talk `pathType` while explaining the rule order. `pathType` determines how broad a ruleâ€™s match is. There are three pathTypes and we should follow this order when adding rules:

1. `pathType: Exact` - This matches the rule exactly the way it's written. The request will match only if the path is exactly `/first-service`. 
```
path: /first-service
pathType: Exact
```
2. `pathType: Prefix` - This matches the prefix and accepts anything after it (`/first-service/*`. So, always add the rule with the longest prefix first.

With the order like this, the request will never match `/api/first-service` because the first rule will match it always (`/api/*`)
```
path: /api/
pathType: Prefix

path: /api/first-service
pathType: Prefix
```

This is the proper order to add Prefix rules
```
path: /api/first-service
pathType: Prefix

path: /api/
pathType: Prefix
```

3. `pathType: ImplementationSpecific` - This is like a mix of `Prefix` and `Exact`. For each path it will add a rule with an `OR` condition. E.g:

1. If `PATH` is `/api` OR `/api/*` then...
2. If `PATH` is `/api/first-service` OR `/api/first-service/*` then...

So be careful, because like in this scenario, the `/api/first-service` will never reach the proper rule as `api/*` will always be matched.

```
path: /api
pathType: ImplementationSpecific

path: /api/first-service
pathType: ImplementationSpecific
```

#### Priority

The order we set the rules matter because of the rule evalution
but when using multiple ingressess it~s importatnt to define the froup.order


